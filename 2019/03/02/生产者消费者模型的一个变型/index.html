<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>【本科时期文章】生产者消费者模型的一个例子 | Hexo</title>
  <meta name="description" content="一般的生产者消费者模型中，生产者和消费者都是尽可能快地处理任务。但在工作中，我遇到了一种情况，需要每个消费者尽可能多地解决一批任务，这样可以打包处理，降低I&#x2F;O频次。我当时用的方法是在消费者端给BlockingQueue加锁。后来想想这种方法多余了。这篇文章一是讨论一下这种方法，作个反思，二来作为新博客的第一篇文章，起个开头。">
<meta property="og:type" content="article">
<meta property="og:title" content="【本科时期文章】生产者消费者模型的一个例子">
<meta property="og:url" content="https://juniousy.github.io/2019/03/02/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%80%E4%B8%AA%E5%8F%98%E5%9E%8B/index.html">
<meta property="og:site_name" content="JuniousY的博客">
<meta property="og:description" content="一般的生产者消费者模型中，生产者和消费者都是尽可能快地处理任务。但在工作中，我遇到了一种情况，需要每个消费者尽可能多地解决一批任务，这样可以打包处理，降低I&#x2F;O频次。我当时用的方法是在消费者端给BlockingQueue加锁。后来想想这种方法多余了。这篇文章一是讨论一下这种方法，作个反思，二来作为新博客的第一篇文章，起个开头。">
<meta property="og:locale">
<meta property="article:published_time" content="2019-03-02T14:08:53.000Z">
<meta property="article:modified_time" content="2022-05-30T09:06:50.985Z">
<meta property="article:author" content="JuniousY">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="并发">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="https://juniousy.github.io/2019/03/02/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%80%E4%B8%AA%E5%8F%98%E5%9E%8B/index.html">
  
    <link rel="alternate" href="/atom.xml" title="JuniousY的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.3.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/JuniousY" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">JuniousY</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">后端程序员</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shanghai, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/JuniousY" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%B7%E9%A2%98/">刷题</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E8%B0%88/">杂谈</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E8%B0%88/" rel="tag">杂谈</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E7%BB%8F/" rel="tag">面经</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Java/" style="font-size: 14px;">Java</a> <a href="/tags/Redis/" style="font-size: 13.33px;">Redis</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 13.67px;">并发</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size: 13px;">杂谈</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 13.33px;">算法</a> <a href="/tags/%E9%9D%A2%E7%BB%8F/" style="font-size: 13px;">面经</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E6%9D%82%E8%B0%88/">杂谈</a>
              </p>
              <p class="item-title">
                <a href="/2021/01/29/%E6%9C%AC%E7%A7%91%E5%90%8E%E8%87%B3%E4%BB%8A%EF%BC%88%E4%B8%80%E5%B9%B4%E5%8D%8A%EF%BC%89%E7%9A%84%E4%B8%80%E7%82%B9%E7%82%B9%E6%84%9F%E6%83%B3/" class="title">本科后至今（一年半）的一点点感想</a>
              </p>
              <p class="item-date">
                <time datetime="2021-01-29T13:00:00.000Z" itemprop="datePublished">2021-01-29</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>
              </p>
              <p class="item-title">
                <a href="/2019/06/23/%E8%99%8E%E6%89%91%E9%9D%A2%E7%BB%8F%E4%B8%8E%E6%80%BB%E7%BB%93/" class="title">【本科时期文章】虎扑面经</a>
              </p>
              <p class="item-date">
                <time datetime="2019-06-23T13:51:06.000Z" itemprop="datePublished">2019-06-23</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>
              </p>
              <p class="item-title">
                <a href="/2019/06/14/Java-%E5%90%8C%E6%AD%A5%E5%99%A8%E6%A0%B8%E5%BF%83AQS/" class="title">【本科时期文章】Java 同步器核心AQS</a>
              </p>
              <p class="item-date">
                <time datetime="2019-06-14T03:27:12.000Z" itemprop="datePublished">2019-06-14</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>
              </p>
              <p class="item-title">
                <a href="/2019/06/05/Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%BC%96%E7%A0%81/" class="title">【本科时期文章】Redis的数据结构与编码</a>
              </p>
              <p class="item-date">
                <time datetime="2019-06-05T07:42:40.000Z" itemprop="datePublished">2019-06-05</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>
              </p>
              <p class="item-title">
                <a href="/2019/06/04/%E4%BB%8ERedis-I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E5%88%B0Java-NIO-Selector/" class="title">【本科时期文章】从Redis I/O多路复用到Java NIO Selector</a>
              </p>
              <p class="item-date">
                <time datetime="2019-06-04T07:19:21.000Z" itemprop="datePublished">2019-06-04</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-生产者消费者模型的一个变型" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      【本科时期文章】生产者消费者模型的一个例子
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2019/03/02/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%80%E4%B8%AA%E5%8F%98%E5%9E%8B/" class="article-date">
	  <time datetime="2019-03-02T14:08:53.000Z" itemprop="datePublished">2019-03-02</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/Java/" rel="tag">Java</a>, <a class="article-tag-link-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2019/03/02/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%80%E4%B8%AA%E5%8F%98%E5%9E%8B/#comments" class="article-comment-link">Comments</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count: 3.3k(words)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">Read Count: 15(minutes)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>一般的生产者消费者模型中，生产者和消费者都是尽可能快地处理任务。但在工作中，我遇到了一种情况，需要每个消费者尽可能多地解决一批任务，这样可以打包处理，降低I/O频次。<br>我当时用的方法是在消费者端给BlockingQueue加锁。后来想想这种方法多余了。<br>这篇文章一是讨论一下这种方法，作个反思，二来作为新博客的第一篇文章，起个开头。</p>
<a id="more"></a>
<hr>
<h4 id="模拟当时的解决方法"><a href="#模拟当时的解决方法" class="headerlink" title="模拟当时的解决方法"></a>模拟当时的解决方法</h4><p>用来解决生产者消费者问题的BlockingQueue：</p>
<pre><code class="java">private static final BlockingQueue&lt;Task&gt; taskBlockingQueue = new ArrayBlockingQueue&lt;&gt;(100);</code></pre>
<p>生产者部分没有什么区别，直接往队列里添加任务：</p>
<pre><code class="java">private void produce(int taskId) &#123;
  try &#123;
    taskBlockingQueue.put(new Task(taskId));
    System.out.println(String.format(&quot;生产者%d\t添加任务%d&quot;, id, taskId));
  &#125; catch (InterruptedException e) &#123;
    e.printStackTrace();
  &#125;
&#125;</code></pre>
<p>消费者部分在打包的过程中都对阻塞队列加锁，不允许其他消费者获取任务：</p>
<pre><code class="java">private static final Lock packageLock = new ReentrantLock();</code></pre>
<p>消费者需要在指定时间内打包，超时则退出这轮消费。</p>
<pre><code class="java">private void consume() &#123;
  try &#123;
    if (packageLock.tryLock(5, TimeUnit.MILLISECONDS)) &#123;
      try &#123;
        doPackage();
      &#125; finally &#123;
        packageLock.unlock();
      &#125;
    &#125;
  &#125; catch (InterruptedException e) &#123;
    e.printStackTrace();
  &#125;
&#125;

private void doPackage() &#123;
  long start = System.currentTimeMillis();
  long end;
  int packageNum = 0;
  for (int i = 0; i &lt; consumerPackageSize; i++) &#123;
    doConsume();
    packageNum++;
    end = System.currentTimeMillis();
    if (end - start &gt; packageTime) &#123;
      break;
    &#125;
  &#125;
  end = System.currentTimeMillis();
  System.out.println(String.format(&quot;消费者%d\t打包%d个\t耗时%d&quot;, id, packageNum, end - start));
&#125;

private void doConsume() &#123;
  Task task = null;
  try &#123;
    task = taskBlockingQueue.poll(100, TimeUnit.MILLISECONDS);
  &#125; catch (InterruptedException e) &#123;
    e.printStackTrace();
  &#125;
  if (task == null) &#123;
    return;
  &#125;
  System.out.println(String.format(&quot;消费者%d\t完成任务%d&quot;, id, task.getId()));
&#125;
</code></pre>
<p>整个完整的测试类：</p>
<pre><code class="java">import lombok.AllArgsConstructor;
import lombok.Data;

import java.util.Random;
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

/**
 * @author Junious
 * @date 2019/02/25
 **/
public class ProducerAndConsumerTest &#123;

  private static final int producerNumber = 5;

  private static final int consumerNumber = 5;

  private static final BlockingQueue&lt;Task&gt; taskBlockingQueue = new ArrayBlockingQueue&lt;&gt;(100);

  private static final Lock packageLock = new ReentrantLock();

  private static final int consumerPackageSize = 20;
  private static final int packageTime = 2000;

  public static void main(String[] args) &#123;
    Runtime.getRuntime().addShutdownHook(
        new Thread(() -&gt; System.out.println
            (&quot;queue size:&quot; + taskBlockingQueue.size()))
    );
    ProducerAndConsumerTest test = new ProducerAndConsumerTest();
    test.init();
  &#125;

  private void init() &#123;
    //add producers
    for (int i = 0; i &lt; producerNumber; i++) &#123;
      Thread t = new Thread(new Producer(i));
      t.start();
    &#125;
    //add consumers
    for (int i = 0; i &lt; consumerNumber; i++) &#123;
      Thread t = new Thread(new Consumer(i));
      t.start();
    &#125;
  &#125;

  @AllArgsConstructor
  @Data
  class Producer implements Runnable &#123;

    private int id;

    @Override
    public void run() &#123;
      Random random = new Random();
      while (true) &#123;
        int taskId = random.nextInt(1000) + 1;
        produce(taskId);
        try &#123;
          Thread.sleep(random.nextInt(300) + 400);
        &#125; catch (InterruptedException e) &#123;
          e.printStackTrace();
          break;
        &#125;
      &#125;
    &#125;

    private void produce(int taskId) &#123;
      try &#123;
        taskBlockingQueue.put(new Task(taskId));
        System.out.println(String.format(&quot;生产者%d\t添加任务%d&quot;, id, taskId));
      &#125; catch (InterruptedException e) &#123;
        e.printStackTrace();
      &#125;
    &#125;
  &#125;

  @AllArgsConstructor
  @Data
  class Consumer implements Runnable &#123;

    private int id;

    @Override
    public void run() &#123;
      Random random = new Random();
      while (true) &#123;
        consume();
        try &#123;
          Thread.sleep(random.nextInt(300) + 400);
        &#125; catch (InterruptedException e) &#123;
          e.printStackTrace();
          break;
        &#125;
      &#125;
    &#125;

    private void consume() &#123;
      try &#123;
        if (packageLock.tryLock(5, TimeUnit.MILLISECONDS)) &#123;
          try &#123;
            doPackage();
          &#125; finally &#123;
            packageLock.unlock();
          &#125;
        &#125;
      &#125; catch (InterruptedException e) &#123;
        e.printStackTrace();
      &#125;
    &#125;

    private void doPackage() &#123;
      long start = System.currentTimeMillis();
      long end;
      int packageNum = 0;
      for (int i = 0; i &lt; consumerPackageSize; i++) &#123;
        doConsume();
        packageNum++;
        end = System.currentTimeMillis();
        if (end - start &gt; packageTime) &#123;
          break;
        &#125;
      &#125;
      end = System.currentTimeMillis();
      System.out.println(String.format(&quot;消费者%d\t打包%d个\t耗时%d&quot;, id, packageNum, end - start));
    &#125;

    private void doConsume() &#123;
      Task task = null;
      try &#123;
        task = taskBlockingQueue.poll(100, TimeUnit.MILLISECONDS);
      &#125; catch (InterruptedException e) &#123;
        e.printStackTrace();
      &#125;
      if (task == null) &#123;
        return;
      &#125;
      System.out.println(String.format(&quot;消费者%d\t完成任务%d&quot;, id, task.getId()));
    &#125;

  &#125;

&#125;

@AllArgsConstructor
@Data
class Task &#123;

  private int id;

&#125;
</code></pre>
<p>截取一段测试结果：</p>
<pre><code>生产者0    添加任务545
生产者2    添加任务943
生产者1    添加任务359
生产者3    添加任务97
生产者4    添加任务705
消费者2    完成任务545
消费者2    完成任务359
消费者2    完成任务943
消费者2    完成任务97
消费者2    完成任务705
生产者2    添加任务32
消费者2    完成任务32
生产者4    添加任务488
消费者2    完成任务488
生产者1    添加任务691
消费者2    完成任务691
消费者2    完成任务3
生产者3    添加任务3
生产者0    添加任务815
消费者2    完成任务815
消费者2    完成任务290
生产者1    添加任务290
消费者2    完成任务408
生产者2    添加任务408
消费者2    完成任务873
生产者3    添加任务873
消费者2    打包20个    耗时1165
生产者0    添加任务852
消费者1    完成任务852
消费者1    完成任务743
生产者4    添加任务743
生产者0    添加任务114
消费者1    完成任务114
生产者1    添加任务454
消费者1    完成任务454
消费者1    完成任务920
生产者2    添加任务920
生产者3    添加任务847
消费者1    完成任务847
生产者4    添加任务905
消费者1    完成任务905
生产者3    添加任务698
消费者1    完成任务698
生产者1    添加任务372
消费者1    完成任务372
生产者0    添加任务568
消费者1    完成任务568
生产者2    添加任务419
消费者1    完成任务419
生产者4    添加任务417
消费者1    完成任务417
消费者1    打包20个    耗时1295
生产者3    添加任务888
消费者0    完成任务888
生产者1    添加任务189
消费者0    完成任务189
生产者2    添加任务892
消费者0    完成任务892
生产者4    添加任务375
消费者0    完成任务375
生产者0    添加任务723
消费者0    完成任务723
生产者3    添加任务543
消费者0    完成任务543
消费者0    完成任务205
生产者1    添加任务205
生产者2    添加任务657
消费者0    完成任务657
生产者0    添加任务549
消费者0    完成任务549
生产者4    添加任务812
消费者0    完成任务812
生产者3    添加任务737
消费者0    完成任务737
消费者0    打包20个    耗时1208
生产者2    添加任务784
消费者4    完成任务784
生产者1    添加任务252
消费者4    完成任务252
生产者0    添加任务622
消费者4    完成任务622
生产者4    添加任务524
消费者4    完成任务524
生产者3    添加任务73
消费者4    完成任务73
生产者2    添加任务491
消费者4    完成任务491
生产者0    添加任务225
消费者4    完成任务225
生产者1    添加任务207
消费者4    完成任务207
生产者4    添加任务326
消费者4    完成任务326
生产者2    添加任务983
消费者4    完成任务983
生产者0    添加任务865
消费者4    完成任务865
生产者3    添加任务347
消费者4    完成任务347
消费者4    打包20个    耗时1318</code></pre>
<p>可以看到每次打包只有一个消费者在进行消费，其实相当于只有一个消费者线程，等于没有使用并发。<br>当消费者任务很耗时时：</p>
<pre><code class="java">private void doConsume() &#123;
  Task task = null;
  try &#123;
    task = taskBlockingQueue.poll(100, TimeUnit.MILLISECONDS);
    //模拟耗时
    Thread.sleep(200);
  &#125; catch (InterruptedException e) &#123;
    e.printStackTrace();
  &#125;
  if (task == null) &#123;
    return;
  &#125;
  System.out.println(String.format(&quot;消费者%d\t完成任务%d&quot;, id, task.getId()));
&#125;</code></pre>
<p>这时候在中止时可以看到队列有10到30不等的Task暂留。模拟耗时越长，暂留的越多，也就是相当于性能越差。</p>
<hr>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>实际上不需要加锁，设定一个超时时间即可。</p>
<pre><code class="java">@AllArgsConstructor
@Data
class Consumer2 implements Runnable &#123;

  private int id;

  @Override
  public void run() &#123;
    Random random = new Random();
    while (true) &#123;
      try &#123;
        consume();
        Thread.sleep(random.nextInt(300) + 400);
      &#125; catch (InterruptedException e) &#123;
        e.printStackTrace();
        break;
      &#125;
    &#125;
  &#125;

  private void consume() throws InterruptedException &#123;
    long start = System.currentTimeMillis();
    ArrayList&lt;Task&gt; tasks = new ArrayList&lt;&gt;();
    long end;
    int packageNum = 0;
    for (int i = 0; i &lt; consumerPackageSize; i++) &#123;
      //模拟打包任务
      Task task = taskBlockingQueue.poll(packageTime, TimeUnit.MILLISECONDS);
      if (task == null) &#123;
        continue;
      &#125;
      Thread.sleep(200);
      tasks.add(task);
      packageNum++;
      end = System.currentTimeMillis();
      if (end - start &gt; packageTime) &#123;
        break;
      &#125;
    &#125;
    end = System.currentTimeMillis();
    System.out.println(String.format(&quot;消费者%d\t打包%d个\t耗时%d\t%s&quot;, id, packageNum, end - start, tasks));
  &#125;

&#125;</code></pre>
<pre><code>生产者2    添加任务539
生产者0    添加任务319
生产者1    添加任务655
生产者4    添加任务843
生产者3    添加任务788
生产者0    添加任务716
生产者3    添加任务176
生产者4    添加任务735
生产者2    添加任务7
生产者1    添加任务283
生产者4    添加任务466
生产者3    添加任务486
生产者0    添加任务649
生产者2    添加任务373
生产者1    添加任务158
生产者0    添加任务532
生产者4    添加任务914
生产者1    添加任务734
生产者3    添加任务571
生产者2    添加任务114
生产者1    添加任务340
生产者3    添加任务670
生产者0    添加任务482
生产者2    添加任务298
生产者4    添加任务598
消费者0    打包5个    耗时2213    [Task(id=655), Task(id=716), Task(id=466), Task(id=532), Task(id=340)]
消费者4    打包5个    耗时2280    [Task(id=319), Task(id=176), Task(id=486), Task(id=914), Task(id=670)]
消费者1    打包5个    耗时2328    [Task(id=788), Task(id=735), Task(id=649), Task(id=734), Task(id=482)]
消费者3    打包5个    耗时2351    [Task(id=843), Task(id=7), Task(id=373), Task(id=571), Task(id=298)]
消费者2    打包5个    耗时2400    [Task(id=539), Task(id=283), Task(id=158), Task(id=114), Task(id=598)]
生产者3    添加任务928
生产者0    添加任务360
生产者1    添加任务724
生产者2    添加任务539
生产者4    添加任务926
生产者3    添加任务206
生产者0    添加任务596
生产者1    添加任务841
生产者4    添加任务834
生产者2    添加任务340
生产者3    添加任务585
生产者1    添加任务500
生产者4    添加任务532
生产者0    添加任务800
生产者2    添加任务914
生产者3    添加任务202
生产者1    添加任务850
生产者0    添加任务506
生产者1    添加任务785
生产者2    添加任务633
生产者4    添加任务182
生产者3    添加任务154
生产者0    添加任务13
生产者2    添加任务880
消费者3    打包5个    耗时2199    [Task(id=724), Task(id=841), Task(id=532), Task(id=506), Task(id=13)]
生产者4    添加任务214
消费者0    打包5个    耗时2217    [Task(id=539), Task(id=834), Task(id=800), Task(id=785), Task(id=880)]
生产者1    添加任务789
生产者3    添加任务786
消费者4    打包6个    耗时2583    [Task(id=928), Task(id=926), Task(id=340), Task(id=914), Task(id=633), Task(id=214)]
生产者0    添加任务468
生产者2    添加任务189
消费者1    打包6个    耗时2597    [Task(id=360), Task(id=206), Task(id=585), Task(id=202), Task(id=182), Task(id=789)]
消费者2    打包5个    耗时2465    [Task(id=596), Task(id=500), Task(id=850), Task(id=154), Task(id=786)]
生产者4    添加任务812
生产者0    添加任务239
生产者3    添加任务671
生产者1    添加任务730
生产者2    添加任务124
生产者4    添加任务679
生产者0    添加任务320
生产者2    添加任务917
生产者1    添加任务986
生产者3    添加任务557
生产者0    添加任务415
生产者4    添加任务559
生产者2    添加任务880
生产者1    添加任务920
生产者3    添加任务502
生产者0    添加任务679
生产者4    添加任务823
生产者2    添加任务594
生产者1    添加任务336
生产者3    添加任务502
生产者0    添加任务453
生产者4    添加任务360
消费者0    打包6个    耗时2249    [Task(id=468), Task(id=239), Task(id=679), Task(id=415), Task(id=679), Task(id=453)]
消费者3    打包6个    耗时2320    [Task(id=189), Task(id=671), Task(id=320), Task(id=559), Task(id=823), Task(id=360)]
生产者2    添加任务823
生产者3    添加任务857
生产者1    添加任务395
生产者0    添加任务937
生产者4    添加任务817
消费者2    打包4个    耗时2264    [Task(id=917), Task(id=880), Task(id=594), Task(id=823)]
消费者4    打包6个    耗时2622    [Task(id=812), Task(id=730), Task(id=986), Task(id=920), Task(id=336), Task(id=857)]
消费者1    打包5个    耗时2408    [Task(id=124), Task(id=557), Task(id=502), Task(id=502), Task(id=395)]
</code></pre>
<p>这时候中止可以看到队列几乎没有Task暂留</p>
<p>当设置消费者消费时间为1000ms时，运行一段时间队列就满了，这时候是当增加消费者线程数即可让任务处理跟上生产者的生产速度。</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://juniousy.github.io/2019/03/02/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%80%E4%B8%AA%E5%8F%98%E5%9E%8B/" title="【本科时期文章】生产者消费者模型的一个例子" target="_blank" rel="external">https://juniousy.github.io/2019/03/02/生产者消费者模型的一个变型/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/JuniousY" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/JuniousY" target="_blank"><span class="text-dark">JuniousY</span><small class="ml-1x">后端程序员</small></a></h3>
        <div>倾听GHOST的低语。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2019/03/11/%E5%AE%9E%E7%8E%B0LRUCache/" title="【本科时期文章】实现LRUCache"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
    </li>
    
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,twitter" data-mobile-sites="weibo,qq"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/JuniousY" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>


    <!-- Highlight.js -->
    <link rel="stylesheet"
          href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">
    <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js">
    </script>
    <script>
        hljs.initHighlightingOnLoad();
    </script>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   






</body>
</html>