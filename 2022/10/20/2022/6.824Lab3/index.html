<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>MIT 6.824 Lab3 | Hexo</title>
  <meta name="description" content="Lab3的目标是利用Raft的机制，实现一个线性一致（Linearizability）的key-value存储结构。 Lab3A概述通过测试 Test: one client (3A) ... labgob warning: Decoding into a non-default variable&#x2F;field Err may not work   ... Passed --  15.2  5  7">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT 6.824 Lab3">
<meta property="og:url" content="https://juniousy.github.io/2022/10/20/2022/6.824Lab3/index.html">
<meta property="og:site_name" content="JuniousY的博客">
<meta property="og:description" content="Lab3的目标是利用Raft的机制，实现一个线性一致（Linearizability）的key-value存储结构。 Lab3A概述通过测试 Test: one client (3A) ... labgob warning: Decoding into a non-default variable&#x2F;field Err may not work   ... Passed --  15.2  5  7">
<meta property="og:locale">
<meta property="article:published_time" content="2022-10-20T15:59:59.000Z">
<meta property="article:modified_time" content="2023-04-09T15:51:46.136Z">
<meta property="article:author" content="JuniousY">
<meta property="article:tag" content="distributed system">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="https://juniousy.github.io/2022/10/20/2022/6.824Lab3/index.html">
  
    <link rel="alternate" href="/atom.xml" title="JuniousY的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.2"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/JuniousY" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">JuniousY</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">后端程序员</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shanghai, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/JuniousY" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Lab/">Lab</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%B7%E9%A2%98/">刷题</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a><span class="category-list-count">8</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/distributed-system/" rel="tag">distributed system</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Java/" style="font-size: 13.67px;">Java</a> <a href="/tags/Redis/" style="font-size: 13px;">Redis</a> <a href="/tags/distributed-system/" style="font-size: 14px;">distributed system</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 13.33px;">并发</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 13.33px;">算法</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Lab/">Lab</a>
              </p>
              <p class="item-title">
                <a href="/2023/05/05/2023/6.824Lab4/" class="title">MIT 6.824 Lab4</a>
              </p>
              <p class="item-date">
                <time datetime="2023-05-05T15:59:59.000Z" itemprop="datePublished">2023-05-05</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Lab/">Lab</a>
              </p>
              <p class="item-title">
                <a href="/2022/10/20/2022/6.824Lab3/" class="title">MIT 6.824 Lab3</a>
              </p>
              <p class="item-date">
                <time datetime="2022-10-20T15:59:59.000Z" itemprop="datePublished">2022-10-20</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>
              </p>
              <p class="item-title">
                <a href="/2022/09/20/2022/%E9%9D%9E%E9%80%92%E5%BD%92%E4%B8%AD%E5%BA%8F%E9%81%8D%E5%8E%86%E4%BA%8C%E5%8F%89%E6%A0%91/" class="title">非递归中序遍历二叉树</a>
              </p>
              <p class="item-date">
                <time datetime="2022-09-19T17:37:00.000Z" itemprop="datePublished">2022-09-20</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Lab/">Lab</a>
              </p>
              <p class="item-title">
                <a href="/2022/08/29/2022/6.824Lab2C/" class="title">MIT 6.824 Lab2C</a>
              </p>
              <p class="item-date">
                <time datetime="2022-08-29T15:30:30.000Z" itemprop="datePublished">2022-08-29</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Lab/">Lab</a>
              </p>
              <p class="item-title">
                <a href="/2022/08/09/2022/6.824Lab2B/" class="title">MIT 6.824 Lab2B</a>
              </p>
              <p class="item-date">
                <time datetime="2022-08-08T17:01:45.000Z" itemprop="datePublished">2022-08-09</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-2022/6.824Lab3" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      MIT 6.824 Lab3
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2022/10/20/2022/6.824Lab3/" class="article-date">
	  <time datetime="2022-10-20T15:59:59.000Z" itemprop="datePublished">2022-10-20</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Lab/">Lab</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/distributed-system/" rel="tag">distributed system</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/10/20/2022/6.824Lab3/#comments" class="article-comment-link">Comments</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count: 3k(words)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">Read Count: 12(minutes)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>Lab3的目标是利用Raft的机制，实现一个线性一致（Linearizability）的key-value存储结构。</p>
<h1 id="Lab3A"><a href="#Lab3A" class="headerlink" title="Lab3A"></a>Lab3A</h1><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>通过测试</p>
<pre><code>Test: one client (3A) ...
labgob warning: Decoding into a non-default variable/field Err may not work
  ... Passed --  15.2  5  7307  289
Test: many clients (3A) ...
  ... Passed --  15.9  5 12944 1483
Test: unreliable net, many clients (3A) ...
  ... Passed --  16.1  5  3911 1029
Test: concurrent append to same key, unreliable (3A) ...
  ... Passed --   1.2  3   163   52
Test: progress in majority (3A) ...
  ... Passed --   1.2  5   167    2
Test: no progress in minority (3A) ...
  ... Passed --   1.1  5   191    3
Test: completion after heal (3A) ...
  ... Passed --   1.1  5    96    3
Test: partitions, one client (3A) ...
  ... Passed --  22.4  5 15465  175
Test: partitions, many clients (3A) ...
  ... Passed --  23.2  5 23550 1158
Test: restarts, one client (3A) ...
  ... Passed --  21.3  5 21560  289
Test: restarts, many clients (3A) ...
  ... Passed --  23.3  5 105143 1445
Test: unreliable net, restarts, many clients (3A) ...
  ... Passed --  23.6  5  5069 1145
Test: restarts, partitions, many clients (3A) ...
  ... Passed --  29.1  5 78246  825
Test: unreliable net, restarts, partitions, many clients (3A) ...
  ... Passed --  32.1  5  4443  507
Test: unreliable net, restarts, partitions, many clients, linearizability checks (3A) ...
  ... Passed --  28.8  7  9497  887
PASS
</code></pre>
<p>一开始看到Lab3A的时候完全不知道从何入手，仔细看了下的话，其实kv server分为三个部分：Client, Server, Raft。其中Raft是Server的底层，是分布式Server做到线性一致的基础。这其中的通信关系是：Client &lt;=&gt; Server, Server &lt;=&gt; Raft, Raft &lt;=&gt; Raft。有两个重要的点，一个是Server和Server之间是不通信的，必须通过Raft通信，第二个是Server和Raft是一对一的关系，只有Raft leader对应的Server才有操作的资格。另外有一个细节是，在这个lab里，每个Get请求也必须通过raft协议才能完成，这样做的目的是保证线性一致。</p>
<h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><p>首先从Cliet处着手。保证消息不重复消费最重要的一部分是Client会有自己的clientId，每次指令也有一个commandId。Client的Get和Put方法就是循环调用server的接口，如果不成功就换下一个server，直到server返回成功。</p>
<pre><code class="go">for &#123;
  var getArgs GetArgs = GetArgs&#123;
    Key:       key,
    ClientId:  ck.clientId,
    CommandId: ck.commandId,
  &#125;
  var getReply GetReply
  for &#123;
    ok := ck.servers[ck.leaderId].Call(&quot;KVServer.Get&quot;, &amp;getArgs, &amp;getReply)
    if !ok || getReply.Err == ErrWrongLeader || getReply.Err == ErrTimeout &#123;
      ck.leaderId = (ck.leaderId + 1) % (len(ck.servers))
      continue
    &#125;
    DPrintf(&quot;###client %v Get ok %#v, commandId:&#39;%v&#39; \n&quot;, ck.clientId, getReply, ck.commandId)
    ck.commandId++
    return getReply.Value
  &#125;
&#125;
</code></pre>
<h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p>Server端会比较复杂。Server和Client通信是用的RPC，那么Server和Raft是怎么通信的呢？答案是Server向Raft发起请求是通过Raft的Start()入口方法，然后通过Raft的applyCh这个channel来获取数据。因此在Server新建的时候，需要新开一个线程用来获取applyCh的数据。</p>
<p>Start方法传入的数据结构会存到Raft的日志中：</p>
<pre><code class="go">type Op struct &#123;
    Type      string // get put append
    Key       string
    Value     string
    ClientId  int64
    CommandId int
&#125;
</code></pre>
<p>Server在收到Get、Put、Append的RPC请求时，要做这几件事：</p>
<ol>
<li>构造Op参数</li>
<li>根据ClientId和CommandId判断是不是重复请求</li>
<li>调用Raft的Start方法</li>
<li>收到Start方法结果，如果返回值中isLeader是false，就返回ErrWrongLeader给Client</li>
<li>生成一个channel，在applyCh数据返回后给 apply message 线程后，线程会把数据传回到这个channel。接收成功就可以返回给client结果。</li>
</ol>
<p>这个channel需要做超时处理：</p>
<pre><code class="go">DPrintf(&quot;leader %v 开始等待PutAppend结果: index %v, isLeader %v, args %+v&quot;, kv.me, index, isLeader, args)
ch := kv.makeNotifyChan(index)
kv.mu.Unlock()
select &#123;
case &lt;-time.After(ExecuteTimeout):
  DPrintf(&quot;leader %v PutAppend 超时: index %v, isLeader %v, args %+v&quot;, kv.me, index, isLeader, args)
  reply.Err = ErrTimeout
case &lt;-ch:
  reply.Err = OK
  DPrintf(&quot;leader %v PutAppend结果得到: index %v, isLeader %v, args %+v, reply %+v&quot;, kv.me, index, isLeader, args, reply)
&#125;
go func() &#123; kv.closeNotifyChan(index) &#125;()
</code></pre>
<p>apply message 线程就是循环读取applyCh传来的数据，如果是写入操作，就把操作写入server的数据库中。在本lab里，这个操作是写入到一个map里。这里有一个重要的点，是判断applyCh传来的数据是不是过时的数据。因此，我的做法是在server中维护一个结构<code>prevOperation map[int64]CommandResponse</code>，记录每个Client上一次返回结果。CommandResponse中有CommandId信息。如果applyCh传来的数据中，它的CommandId小于等于前一次返回结果的CommandId，就直接抛弃这条消息。最后server把数据传回给rpc请求：</p>
<pre><code class="go">ch := kv.getNotifyChan(message.CommandIndex)
if ch != nil &#123;
  ch &lt;- response
&#125;
</code></pre>
<p>这里有个细节是如果拿不到channel了，就说明rpc方法已经超时返回了，删除了这个channel。这里的处理是试了很多次之后定下来的，能通过测试，但可能还是有点疑问。因为如果这里不传消息，其实是相当于丢了一次已经记录到Raft中的消息，而如果不传，那这里因为rpc已经返回了，所以channel会永远在等待发送消息中。参考了一下其他人的实现，有的人会说这里不会阻塞，可能是实现的一些细节不同吧。</p>
<p>整个LAB3A做下来的感受其实是挺折磨的，最大的问题是很容易遇到死锁问题，需要写大量的log，尤其是在加锁解锁和channel通信处。下面举几个例子：</p>
<p>死锁一是在上面说的阻塞的情况时发生：</p>
<pre><code class="go">// putappend
DPrintf(&quot;putAppend 0&quot;)
kv.mu.Lock()
DPrintf(&quot;putAppend 1&quot;)
// dosomething
kv.mu.Unlock()

// apply线程
kv.mu.Lock()
...
DPrintf(&quot;apply 1&quot;)
ch &lt;- response
DPrintf(&quot;apply 2&quot;)
kv.mu.Unlock()
DPrintf(&quot;apply 3&quot;)
</code></pre>
<pre><code class="text">// 输出结果
apply 1
putAppend 1
putAppend 0
</code></pre>
<p>由于apply处有锁，而apply阻塞等待消息，因此rpc方法处的锁无法拿到。这里的错误点在于发送消息时应该是没有锁的。要么提前解锁，要么新开一个线程发送消息。</p>
<p>死锁二，apply必须在是leader情况下时才能发送管道消息，不然就永远在等待。为什么呢？因为只有在leader情况下才会新建chanel。当然上面判断channel是不是为空也是一种解决方法，但更正确的做法应该是只在是leader而且term相符情况下才发送消息：</p>
<pre><code class="go">currentTerm, isLeader := kv.rf.GetState()
if isLeader &amp;&amp; message.CommandTerm == currentTerm &#123;
  // send
&#125;
</code></pre>
<p>死锁三是在raft中发生的，这算是之前lab2中一个没有暴露出来的bug。<br>之前在raft发送applyCh消息时，是持有raft的锁的。当apply一次性提交很多个数据时，会一直占用rf.mu。但是在Server处，会调用rf.Start()或者rf.GetState()，这两个都要求锁。于是，Server端等待rf的锁，无法处理applyCh的下一条消息，而raft持有锁，等待向applyCh中发送消息，于是引发了死锁。<br>解决方法和上面一样，在消息发送时，要么解锁，要么新开线程：</p>
<pre><code class="go">// 问题代码：

// server层
currentTerm, isLeader := kv.rf.GetState()

// raft层
//  加锁状态 一次有多个msg发送
rf.applyCh &lt;- msg
</code></pre>
<pre><code class="go">// 需要改成：

rf.mu.Unlock()
rf.applyCh &lt;- msg
rf.mu.Lock()
</code></pre>
<h1 id="Lab3B"><a href="#Lab3B" class="headerlink" title="Lab3B"></a>Lab3B</h1><pre><code>Test: InstallSnapshot RPC (3B) ...
  ... Passed --   7.5  3  4540   63
Test: snapshot size is reasonable (3B) ...
  ... Passed --  41.2  3 10828  800
Test: restarts, snapshots, one client (3B) ...
  ... Passed --  20.8  5 17973  289
Test: restarts, snapshots, many clients (3B) ...
  ... Passed --  25.3  5 129392 5900
Test: unreliable net, snapshots, many clients (3B) ...
  ... Passed --  16.0  5  3476  848
Test: unreliable net, restarts, snapshots, many clients (3B) ...
  ... Passed --  23.5  5  4381  730
Test: unreliable net, restarts, partitions, snapshots, many clients (3B) ...
... Passed --  32.0  5  3448  343
</code></pre>
<p>Lab3B要做的事情很简单，就是将日志压缩为snapshop。但实际我自己做下来比lab3A要繁琐得多，也尝试了很久。而且虽然通过了所有的测试，但最后三个测试有小概率失败，也很难定位到问题。</p>
<p>具体来说，Lab3B的流程是，server在发现日志大小超过某个临界值之后，将自己的数据序列化存储为快照，然后传给raft。raft会删除旧的日志，保留必要的信息。</p>
<h3 id="Server层"><a href="#Server层" class="headerlink" title="Server层"></a>Server层</h3><p>server比较简单，但也会有坑。首先在apply线程中，在拿到raft返回数据后，判断要不要生成快照：</p>
<pre><code class="go">func (kv *KVServer) needSnapshot() bool &#123;
    if kv.maxraftstate == -1 &#123;
        return false
    &#125;
    return kv.persister.RaftStateSize() &gt; kv.maxraftstate
&#125;
</code></pre>
<p>如果需要，就要讲自己的数据map、lastAppliedIndex表和prevOperation表序列化生成快照。后面两个在恢复server的时候是非常有必要的，防止多次提交。在序列化的最后，是调取一个新的Raft方法传递当前的日志index（很重要）和快照数据<code>kv.rf.TakeSnapshot(index, buffer.Bytes())</code>。</p>
<p>反过来也需要一个反序列化的读取方法，将这些数据应用到Server层中。触发的时间点是Raft通过applyCh将操作成功的消息传递给Server层时。一个细节是启动时候也要进行这一步。</p>
<h3 id="Raft层"><a href="#Raft层" class="headerlink" title="Raft层"></a>Raft层</h3><p>首先，Raft层接受Server命令的方法会进行删除日志、记录快照最后包含的Index。Raft层会新增两个字段lastIncludedIndex、lastIncludedTerm。然后leader将快照数据持久化。</p>
<p>然后，Raft层会多一个RPC请求，这是leader向follower发送snapshot命令的请求：</p>
<pre><code class="go">func (rf *Raft) InstallSnapshot(args *InstallSnapshotArgs, reply *InstallSnapshotReply) &#123;
  // ...  省略判断校验逻辑
  logs := make([]Log, 0)
  startIndex := rf.newIndex(args.LastIncludedIndex + 1)
  if startIndex &lt;= len(rf.logEntries) &#123;
    logs = append(logs, rf.logEntries[startIndex:]...)
  &#125;
  rf.logEntries = logs

  rf.lastIncludedIndex = args.LastIncludedIndex
  rf.lastIncludedTerm = args.LastIncludedTerm

  rf.lastApplied = max(rf.lastIncludedIndex, rf.lastApplied)
  rf.commitIndex = max(rf.lastIncludedIndex, rf.commitIndex)

  // ... 省略持久化数据

  // ... 省略发送消息给Server层
&#125;
</code></pre>
<p>这个核心方法是删除日志，然后将相关index修改。</p>
<p>那么，什么时候leader向server发送这一消息呢？我的处理是这样的，每次leader持久化之后就对所有follower进行一次发送。然后，在发送AppendEntries处，如果nextIndex的值已经和日志不匹配了，就说明也要发送。这种情况是follower脱离集群之后再回来会发生的事：</p>
<pre><code class="go">prevLogIndex := rf.nextIndex[id] - 1
if rf.newIndex(prevLogIndex) &gt;= len(rf.logEntries) || rf.newIndex(prevLogIndex) &lt; -1 &#123;
  //fmt.Printf(&quot;#### rf.me %v rf.nextIndex[%v] = %v, rf.lastIncludedIndex %v\n&quot;, rf.me, id, rf.nextIndex[id], rf.lastIncludedIndex)
  rf.mu.Unlock()
  rf.sendSnapshot(id)
  return
&#125;
</code></pre>
<p>这里有一个非常头疼的地方是，下标index怎么处理。日志list是新建的，原来的下标是对应不上的。有两种思路，一种是，在新建日志时，重算所有的下标并更新；另一种思路是，所有的下标保持原样，在使用到日志list上时做处理。<br>一开始，我在尝试了一下第二种思路后，选择放弃了，因为要改的地方很多，以为前一种思路更简单一点，因为只要改一处地方。但实际上试下来非常头疼，debug了很久，因为很容易出现旧下标和新下标混用的情况。具体遇到的问题如：1. Server层在get方法时，apply线程将信息发给了别的rpc接口。因为获取channel的参数是Start方法的返回值中的index，一旦index变化，就会发错数据。2. 在解决了问题一之后，Raft层的数据有概率出现错配的情况，也很难调试出原因。<br>然后我重看了一下论文，再参考了一下别人的实现，思考了一下之后我觉得只有第二种才是正常的实现，因为各种index（如applied index）必须是递增的，没有理由去改动它们。所以，必须在读取日志list时做改动：</p>
<pre><code class="go">func (rf *Raft) newIndex(index int) int &#123;
    return index - rf.lastIncludedIndex - 1
&#125;

func (rf *Raft) trueIndex(index int) int &#123;
    return index + rf.lastIncludedIndex + 1
&#125;
</code></pre>
<p>这里面头疼的点是，有些不是直接和list下标有关的方法内部参数，也需要改动，举一个例子，选举时有一个参数<code>lastLogIndex</code>，就需要算成实际的下标来使用，否则出现的情况是，一个没有数据的新follower会因为term较高而被选举为leader。</p>
<p>解决为下标问题，Lab3B就没有什么大的问题了。总的来说，Lab3需要谨慎规避死锁问题，需要在多线程分布式环境下打充足的日志来调试问题。功能点上可能不是很多，但是很能锻炼工程实现能力和复杂问题处理能力</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://juniousy.github.io/2022/10/20/2022/6.824Lab3/" title="MIT 6.824 Lab3" target="_blank" rel="external">https://juniousy.github.io/2022/10/20/2022/6.824Lab3/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/JuniousY" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/JuniousY" target="_blank"><span class="text-dark">JuniousY</span><small class="ml-1x">后端程序员</small></a></h3>
        <div>倾听GHOST的低语。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2023/05/05/2023/6.824Lab4/" title="MIT 6.824 Lab4"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2022/09/20/2022/%E9%9D%9E%E9%80%92%E5%BD%92%E4%B8%AD%E5%BA%8F%E9%81%8D%E5%8E%86%E4%BA%8C%E5%8F%89%E6%A0%91/" title="非递归中序遍历二叉树"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,twitter" data-mobile-sites="weibo,qq"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/JuniousY" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>


    <!-- Highlight.js -->
    <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/11.5.1/styles/github.min.css">
    <script src="//cdn.bootcss.com/highlight.js/11.5.1/highlight.min.js">
    </script>
    <script>
        hljs.highlightAll();
    </script>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   






</body>
</html>